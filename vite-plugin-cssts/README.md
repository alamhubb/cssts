# vite-plugin-cssts

> Vite 插件，用于处理 `.cssts` 文件并按需生成原子类 CSS

## 核心职责

vite-plugin-cssts 是一个**薄层插件**，只负责 Vite 集成：

1. **调用 cssts-compiler** - 转换 `.cssts` 文件
2. **虚拟模块管理** - 提供 `virtual:csstsAtom` 和 `virtual:cssts.css`
3. **HMR 处理** - 热更新支持

所有核心逻辑都在 `cssts-compiler` 中。

## 设计：统一的样式存储

使用单一的 `Set<string>` 存储所有样式名：

```typescript
// vite-plugin 内部
const globalStyles = new Set<string>()

// 转换时自动填充
transformCssTs(code, { styles: globalStyles })

// 存储的内容
// 'displayFlex'              - 普通原子类
// 'clickable$$hover$$active' - 带伪类的样式
```

生成 CSS 时按需解析，不存储冗余数据。

## 安装

```bash
npm install vite-plugin-cssts -D
```

## 使用

### 配置 Vite

```typescript
// vite.config.ts
import { defineConfig } from 'vite'
import cssTsPlugin from 'vite-plugin-cssts'

export default defineConfig({
  plugins: [
    cssTsPlugin({
      classPrefix: '', // 可选：CSS 类名前缀
      pseudoUtils: {   // 可选：$$ 伪类配置
        hover: { opacity: '0.9' },
        active: { opacity: '0.6' },
        focus: { outline: '2px solid blue' }
      }
    }),
  ],
})
```

### 使用 css {} 语法

```typescript
// Button.cssts

// 普通样式
const buttonStyle = css { displayFlex, padding16px }

// 带伪类的样式（使用 $$ 双美元符号）
const clickable$$hover$$active = css { displayFlex, cursorPointer }
```

## 生成的虚拟模块

### virtual:csstsAtom

包含项目中使用的所有样式：

```typescript
export const csstsAtom = {
  // 普通原子类
  displayFlex: { 'display_flex': true },
  padding16px: { 'padding_16px': true },
  cursorPointer: { 'cursor_pointer': true },
  // 带伪类的样式
  'clickable$$hover$$active': { 'clickable': true },
}
```

### virtual:cssts.css

按需生成的 CSS：

```css
/* Auto-generated by cssts-compiler */

/* cursor */
.cursor_pointer { cursor: pointer; }

/* display */
.display_flex { display: flex; }

/* padding */
.padding_16px { padding: 16px; }

/* $$ Pseudo-class styles */
.clickable:hover { opacity: 0.9; }
.clickable:active { opacity: 0.6; }
```

## 配置选项

| 选项 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `classPrefix` | `string` | `''` | CSS 类名前缀 |
| `pseudoUtils` | `PseudoUtilsConfig` | `undefined` | $$ 伪类配置 |

### pseudoUtils 配置

定义 `$$` 语法使用的伪类属性：

```typescript
cssTsPlugin({
  pseudoUtils: {
    hover: { opacity: '0.9' },
    active: { opacity: '0.6' },
    focus: { outline: '2px solid blue' },
    disabled: { opacity: '0.5', cursor: 'not-allowed' }
  }
})
```

## 架构

```
┌─────────────────────────────────────────────────────────────┐
│  vite-plugin-cssts（薄层）                                   │
│  • Vite 插件 hooks                                          │
│  • 虚拟模块注册                                              │
│  • HMR 处理                                                 │
│  • 全局状态：globalStyles: Set<string>                       │
├─────────────────────────────────────────────────────────────┤
│  cssts-compiler（核心）                                      │
│  • transformCssTs() - 单文件转换                             │
│  • generateStylesCss() - CSS 生成                           │
│  • generateCsstsAtomModule() - 虚拟模块生成                  │
│  • parseStyleName() - 样式名解析                             │
└─────────────────────────────────────────────────────────────┘
```

## License

MIT
